services:
  seal-server:
    build:
      context: ../../../../..
      dockerfile: tools/seal/seal/docker/e2e/Dockerfile.server
      network: ${SEAL_DOCKER_E2E_BUILD_NETWORK:-host}
    container_name: seal-e2e-server
    hostname: seal-e2e-server
    privileged: true
    security_opt:
      - seccomp=unconfined
      - apparmor=unconfined
    cgroupns: ${SEAL_DOCKER_E2E_CGROUPNS:-host}
    dns:
      - 8.8.8.8
      - 1.1.1.1
    tmpfs:
      - /run
      - /tmp
      - /run/lock
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - /sys/kernel/debug:/sys/kernel/debug:rw
      - /sys/kernel/tracing:/sys/kernel/tracing:rw
      - /lib/modules:/lib/modules:ro
      - ${SEAL_DOCKER_E2E_SSH_DIR:-/tmp/seal-ssh}:/tmp/seal-ssh:ro
    environment:
      - SEAL_SERVER_USER=admin
    networks:
      - seal-e2e

  seal-builder:
    build:
      context: ../../../../..
      dockerfile: tools/seal/seal/docker/e2e/Dockerfile.builder
      network: ${SEAL_DOCKER_E2E_BUILD_NETWORK:-host}
    container_name: seal-e2e-builder
    privileged: true
    init: true
    security_opt:
      - seccomp=unconfined
      - apparmor=unconfined
    cgroupns: ${SEAL_DOCKER_E2E_CGROUPNS:-host}
    shm_size: ${SEAL_DOCKER_E2E_SHM_SIZE:-2g}
    working_dir: /workspace
    dns:
      - 8.8.8.8
      - 1.1.1.1
    volumes:
      - ../../../..:/workspace
      - ${SEAL_DOCKER_E2E_SSH_DIR:-/tmp/seal-ssh}:/tmp/seal-ssh:ro
      - /sys/kernel/debug:/sys/kernel/debug:rw
      - /sys/kernel/tracing:/sys/kernel/tracing:rw
      - /lib/modules:/lib/modules:ro
      - ${SEAL_DOCKER_E2E_CACHE_DIR:-/tmp/seal-e2e-cache}:/root/.cache/seal
      - ${SEAL_DOCKER_E2E_CACHE_DIR:-/tmp/seal-e2e-cache}/node_modules:/workspace/node_modules
      - ${SEAL_DOCKER_E2E_CACHE_DIR:-/tmp/seal-e2e-cache}/npm:/root/.npm
    environment:
      - SEAL_DOCKER_E2E=1
      - SEAL_E2E_NODE_MODULES_ROOT=/root/.cache/seal/example-node_modules
      - SEAL_E2E_LIMITED_HOST=${SEAL_E2E_LIMITED_HOST:-0}
      - SEAL_NPM_SKIP_IF_PRESENT=1
      - NPM_CONFIG_UNSAFE_PERM=true
    networks:
      - seal-e2e

networks:
  seal-e2e:
    driver: bridge
